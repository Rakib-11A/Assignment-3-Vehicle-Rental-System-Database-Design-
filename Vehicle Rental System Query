/*
 Title: Vehicle Rantal System Database design and query solution
 Author: Md. Rakib Hasan
 Data: 23/12/2025 (My Birthday)
*/

-- Query 1: Join
-- Retrieve booking information along with customer name & vehcile name

SELECT 
  b.booking_id,
  c.name AS customer_name,
  v.name AS vehicle_name,
  b.start_date,
  b.end_date,
  b.status
FROM bookings AS b
INNER JOIN users AS c ON b.user_id = c.user_id
INNER JOIN vehicles AS v ON b.vehicle_id = v.vehicle_id;

-- Query 2: EXISTS
-- Find all vehicles that have never been booked

SELECT 
  v.vehicle_id,
  v.name,
  v.type,
  v.model,
  v.registration_number,
  v.rental_price,
  v.status
FROM vehicles AS v
where NOT EXISTS (
  SELECT 1
  FROM bookings AS b
  WHERE b.vehicle_id = v.vehicle_id
)
ORDER BY vehicle_id ASC;

-- Query 3: WHERE
-- Retrieve all available vehicles of specific type (e.g cars).


CREATE OR REPLACE FUNCTION get_available_vehicles_by_type(input_type vehicle_type)
RETURNS TABLE (
	vehicle_id BIGINT,
	name VARCHAR,
	type vehicle_type,
	model VARCHAR,
	registration_number VARCHAR,
	rental_price DECIMAL(10, 2),
	status vehicle_status_type
) AS $$
BEGIN
	RETURN QUERY
	SELECT
		v.vehicle_id,
		v.name,
		v.type,
		v.model,
		v.registration_number,
		v.rental_price,
		v.status
	FROM vehicles v
	WHERE v.type = input_type::vehicle_type
	AND v.status = 'available';

	IF NOT FOUND THEN
		RAISE NOTICE 'No available vehicles found for type: %', input_type;
	END IF;
END;
$$ LANGUAGE plpgsql;

SELECT * FROM get_available_vehicles_by_type('car');
SELECT * FROM get_available_vehicles_by_type('bike');
SELECT * FROM get_available_vehicles_by_type('truck');

-- Query 4: GROUP BY and HAVING
-- Find the total number of bookings for each vehicle and display only those vehicles that have more that 2 bookings

SELECT 
	v.name AS vehicle_name,
	COUNT(b.booking_id) AS total_bookings
FROM vehicles v
INNER JOIN bookings b ON v.vehicle_id = b.vehicle_id
GROUP BY v.name
HAVING COUNT(b.booking_id) > 2
ORDER BY total_bookings DESC;



