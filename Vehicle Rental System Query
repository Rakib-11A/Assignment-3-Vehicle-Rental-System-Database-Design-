CREATE OR REPLACE FUNCTION autometic_updated_at() RETURNS TRIGGER AS $$ 
  BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
  END;
$$ LANGUAGE plpgsql;

-- Create ENUM for role

DROP TYPE IF EXISTS role_type CASCADE;
CREATE TYPE role_type AS ENUM ('Admin', 'Customer');

-- Create users table
  
CREATE TABLE IF NOT EXISTS users (
  user_id BIGSERIAL PRIMARY KEY,
  role role_type NOT NULL,
  name VARCHAR(100) NOT NULL,
  email VARCHAR(150) UNIQUE NOT NULL,
  password VARCHAR(255) NOT NULL,
  phone VARCHAR(20),

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Trigger function for users updated_at

CREATE TRIGGER trigger_users_updated_at
BEFORE UPDATE ON users 
FOR EACH ROW 
EXECUTE FUNCTION autometic_updated_at();

-- Create ENUM from vehicle_type

DROP TYPE IF EXISTS vehicle_type CASCADE;
CREATE TYPE vehicle_type AS ENUM('car', 'bike', 'truck');

-- Create ENUM for type and status

DROP TYPE IF EXISTS vehicle_status_type CASCADE;
CREATE TYPE vehicle_status_type AS ENUM ('available', 'rented', 'maintenance');

-- Create Vehicle Table
CREATE TABLE IF NOT EXISTS vehicles (
  vehicle_id BIGSERIAL PRIMARY KEY,
  name VARCHAR(100) NOT NULL,
  type vehicle_type NOT NULL,
  model VARCHAR(150) NOT NULL,
  registration_number VARCHAR(255) UNIQUE NOT NULL,
  rental_price DECIMAL NOT NULL DEFAULT 0.00 CHECK (rental_price >= 0),
  status vehicle_status_type NOT NULL DEFAULT 'available',

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT current_timestamp
);

CREATE TRIGGER trigger_vehicle_updated_at
BEFORE UPDATE ON vehicles
FOR EACH ROW
EXECUTE FUNCTION autometic_updated_at();

-- Create ENUM for status

DROP TYPE IF EXISTS booking_status_type CASCADE;
CREATE TYPE booking_status_type AS ENUM ('pending', 'confirmed', 'cancelled', 'completed');

CREATE TABLE IF NOT EXISTS bookings (
  booking_id BIGSERIAL PRIMARY KEY,
  user_id BIGINT NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
  vehicle_id BIGINT NOT NULL REFERENCES vehicles(vehicle_id) ON DELETE CASCADE,
  start_date DATE NOT NULL,
  end_date DATE NOT NULL,
  status booking_status_type NOT NULL DEFAULT 'pending',
  total_cost DECIMAL(10, 2) DEFAULT 0.00 CHECK( total_cost >= 0),

  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Creating index for very big table which have about to 1 Milion recoreds.

-- CREATE INDEX idx_bookings_user ON bookings(user_id);
-- CREATE INDEX idx_bookings_vehicle ON bookings(vehicle_id);

-- Trigger for bookings table
CREATE TRIGGER update_bookings_updated_at
BEFORE UPDATE ON bookings
FOR EACH ROW 
EXECUTE FUNCTION autometic_updated_at();

-- Data insert into the users table
INSERT INTO users (name, email, password, phone, role) VALUES
('Alice', 'alice@example.com', '$2a$12$R9h/lSAbVLxjCF5nBV5Sbe.S6TfS6S.Gf9/wWwXwYyZz123456789', '1234567890', 'Customer'),
('Bob', 'bob@example.com', '$2a$12$KIX9fG3.A.SByM4.S.SByM4.S.SByM4.S.SByM4.S.SByM4.', '0987654321', 'Admin'),
('Charlie', 'charlie@example.com', '$2a$12$D4.SByM4.S.SByM4.S.SByM4.S.SByM4.S.SByM4.S.SB', '1122334455', 'Customer');

SELECT * FROM users;
-- Data insert into vehicles table

INSERT INTO vehicles (name, type, model, registration_number, rental_price, status) VALUES
('Toyota Corolla', 'car', '2022', 'ABC-123', 50.00, 'available'),
('Honda Civic', 'car', '2021', 'DEF-456', 60.00, 'rented'),
('Yamaha R15', 'bike', '2023', 'GHI-789', 30.00, 'available'),
('Ford F-150', 'truck', '2020', 'JKL-012', 100.00, 'maintenance');

SELECT * FROM vehicles;
-- Data insertion into bookings table

INSERT INTO bookings (user_id, vehicle_id, start_date, end_date, status, total_cost) VALUES
(1, 2, '2023-10-01', '2023-10-05', 'completed', 240.00),
(2, 2, '2023-11-01', '2023-11-03', 'completed', 120.00),
(3, 2, '2023-12-01', '2023-12-02', 'confirmed', 60.00),
(1, 1, '2023-12-10', '2023-12-12', 'pending', 100.00);

SELECT * FROM bookings;

-- Query 1: Join
-- Retrieve booking information along with customer name & vehcile name

SELECT 
  b.booking_id,
  c.name AS customer_name,
  v.name AS vehicle_name,
  b.start_date,
  b.end_date,
  b.status
FROM bookings AS b
INNER JOIN users AS c ON b.user_id = c.user_id
INNER JOIN vehicles AS v ON b.vehicle_id = v.vehicle_id;

-- Query 2: EXISTS
-- Find all vehicles that have never been booked

SELECT 
  v.vehicle_id,
  v.name,
  v.type,
  v.model,
  v.registration_number,
  v.rental_price,
  v.status
FROM vehicles AS v
where NOT EXISTS (
  SELECT 1
  FROM bookings AS b
  WHERE b.vehicle_id = v.vehicle_id
)
ORDER BY vehicle_id ASC;

-- Query 3: WHERE
-- Retrieve all available vehicles of specific type (e.g cars).


CREATE OR REPLACE FUNCTION get_available_vehicles_by_type(input_type vehicle_type)
RETURNS TABLE (
	vehicle_id BIGINT,
	name VARCHAR,
	type vehicle_type,
	model VARCHAR,
	registration_number VARCHAR,
	rental_price DECIMAL(10, 2),
	status vehicle_status_type
) AS $$
BEGIN
	RETURN QUERY
	SELECT
		v.vehicle_id,
		v.name,
		v.type,
		v.model,
		v.registration_number,
		v.rental_price,
		v.status
	FROM vehicles v
	WHERE v.type = input_type::vehicle_type
	AND v.status = 'available';

	IF NOT FOUND THEN
		RAISE NOTICE 'No available vehicles found for type: %', input_type;
	END IF;
END;
$$ LANGUAGE plpgsql;

SELECT * FROM get_available_vehicles_by_type('car');
SELECT * FROM get_available_vehicles_by_type('bike');
SELECT * FROM get_available_vehicles_by_type('truck');

-- Query 4: GROUP BY and HAVING
-- Find the total number of bookings for each vehicle and display only those vehicles that have more that 2 bookings

SELECT 
	v.name AS vehicle_name,
	COUNT(b.booking_id) AS total_bookings
FROM vehicles v
INNER JOIN bookings b ON v.vehicle_id = b.vehicle_id
GROUP BY v.name
HAVING COUNT(b.booking_id) > 2
ORDER BY total_bookings DESC;















